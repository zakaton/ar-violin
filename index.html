<html>
  <head>
    <title>AR Violin</title>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="/aframe.min.js"></script>
    <script _src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="/violin-component.js"></script>
  </head>
  <body>
    <a-scene
      shadow="type: pcfsoft"
      renderer="colorManagement:true; toneMapping:ACESFilmic;"
      violin="side: left; leftHand: #leftHandControls; rightHand: #rightHandControls; modeText: #modeText; pitchText: #pitchText; noteText: #noteText; offsetText: #offsetText; violin: #violin"
    >
      <a-assets>
        <a-asset-item
          id="violinModel"
          src="https://cdn.glitch.global/c7c249a3-eab0-45bc-8eaa-b318f59272cf/violin-model.glb?v=1670709370414"
        ></a-asset-item>
        <img
          crossorigin
          id="circleArrowImageAsset"
          src="https://cdn.glitch.global/c7c249a3-eab0-45bc-8eaa-b318f59272cf/circle-arrow-icon.svg?v=1671032031116"
        />
      </a-assets>

      <a-camera position="0 1.6 0" id="camera">
        <a-entity position="0 0 -0.4" id="hud">
          <a-entity position="-0.25 0.12 0" scale="0.2 0.2 0.2">
            <a-text
              id="modeText"
              value=""
              color="black"
              material="shader: flat;"
              position="0 0 0"
              align="left"
            ></a-text>
            <a-entity scale="3 1 1">
              <a-plane
                height="0.3"
                opacity="0.7"
                width="0.3"
                color="white"
                material="shader: flat;"
                position="0.15 0 -0.001"
              ></a-plane>
            </a-entity>
          </a-entity>

          <a-entity position="0.25 0.12 0" scale="0.2 0.2 0.2">
            <a-text
              id="noteText"
              value="A4"
              color="black"
              material="shader: flat;"
              position="0 0 0"
              align="right"
            ></a-text>
            <a-entity scale="2.5 1 1">
              <a-plane
                height="0.3"
                opacity="0.7"
                width="0.16"
                color="white"
                material="shader: flat;"
                position="-0.08 0 -0.001"
              ></a-plane>
            </a-entity>
          </a-entity>

          <a-entity position="0.25 0.05 0" scale="0.2 0.2 0.2">
            <a-text
              id="pitchText"
              value="100Hz"
              color="black"
              material="shader: flat;"
              position="0 0 0"
              align="right"
            ></a-text>
            <a-entity scale="2.5 1 1">
              <a-plane
                height="0.3"
                opacity="0.7"
                width="0.3"
                color="white"
                material="shader: flat;"
                position="-0.15 0 -0.001"
              ></a-plane>
            </a-entity>
          </a-entity>

          <a-entity position="0.25 -0.02 0" scale="0.2 0.2 0.2">
            <a-text
              id="offsetText"
              value="+50%"
              color="red"
              _material="shader: flat;"
              position="0 0 0"
              align="right"
            ></a-text>
            <a-entity scale="2.5 1 1">
              <a-plane
                height="0.3"
                opacity="0.7"
                width="0.3"
                color="white"
                material="shader: flat;"
                position="-0.15 0 -0.001"
              ></a-plane>
            </a-entity>
          </a-entity>
        </a-entity>
      </a-camera>

      <a-entity
        id="leftHandControls"
        _oculus-touch-controls="hand: left; model: false;"
      >
        <a-entity
          id="violin"
          position="0 0 0"
          scale="8 8 8"
        >
          <a-entity id="violinModelEntity" gltf-model="#violinModel"></a-entity>
          <a-entity
            data-knob="0"
            visible="false"
            position="-0.446 0.04479 0.04014"
          >
            <a-sphere visible="false" color="black" radius="0.01"></a-sphere>
            <a-image
              src="#circleArrowImageAsset"
              scale="0.04 0.04 0.04"
            ></a-image>
          </a-entity>
          <a-entity
            data-knob="1"
            visible="false"
            position="-0.47972 0.02899 0.04086"
          >
            <a-sphere visible="false" color="black" radius="0.01"></a-sphere>
            <a-image
              material="shader: standard; emissiveIntensity: 1; emissive: black;"
              src="#circleArrowImageAsset"
              scale="0.04 0.04 0.04"
            ></a-image>
          </a-entity>
          <a-entity
            data-knob="2"
            visible="false"
            position="-0.49235 0.022 -0.03675"
          >
            <a-sphere visible="false" color="black" radius="0.01"></a-sphere>
            <a-image
              visible="false"
              material="shader: standard; emissiveIntensity: 1; emissive: black;"
              src="#circleArrowImageAsset"
              scale="-0.04 0.04 0.04"
            ></a-image>
          </a-entity>
          <a-entity
            data-knob="3"
            visible="false"
            position="-0.46397 0.04479 -0.03861"
          >
            <a-sphere visible="false" color="black" radius="0.01"></a-sphere>
            <a-image
              material="shader: standard; emissiveIntensity: 1; emissive: black;"
              src="#circleArrowImageAsset"
              scale="-0.04 0.04 0.04"
            ></a-image>
          </a-entity>

          <a-entity
            position="-0.43601 0.06637 0.00903"
            rotation="0.000 -1.700 96.857"
          >
            <a-sphere
              visible="false"
              data-finger="0"
              color="yellow"
              radius="0.003"
            ></a-sphere>
            <a-cylinder
              visible="true"
              data-string="0"
              color="yellow"
              radius="0.001"
              height="0.340"
              position="0 -0.168 0"
            ></a-cylinder>
          </a-entity>

          <a-entity
            position="-0.43601 0.06637 0.00312"
            rotation="-0.068 -0.785 97.453"
          >
            <a-sphere
              visible="false"
              data-finger="1"
              color="green"
              radius="0.003"
            ></a-sphere>
            <a-cylinder
              data-string="1"
              visible="true"
              color="green"
              radius="0.001"
              height="0.340"
              position="0 -0.168 0"
            ></a-cylinder>
          </a-entity>

          <a-entity
            position="-0.43601 0.06637 -0.0024"
            rotation="0.019 0.163 97.514"
          >
            <a-sphere
              visible="false"
              data-finger="2"
              color="blue"
              radius="0.003"
            ></a-sphere>
            <a-cylinder
              visible="true"
              data-string="2"
              color="blue"
              radius="0.001"
              height="0.340"
              position="0 -0.168 0"
            ></a-cylinder>
          </a-entity>

          <a-entity
            position="-0.43601 0.06637 -0.0075"
            rotation="-0.057 1.181 96.930"
          >
            <a-sphere
              visible="false"
              data-finger="3"
              color="purple"
              radius="0.003"
            ></a-sphere>
            <a-cylinder
              visible="true"
              data-string="3"
              color="purple"
              radius="0.001"
              height="0.340"
              position="0 -0.168 0"
            ></a-cylinder>
          </a-entity>

          <a-entity position="-0.43601 0.06637 0" rotation="0 0 97.7">
            <a-cylinder
              visible="false"
              color="black"
              position="0 -0.140 0"
              rotation="0 0 0"
              height="0.280"
              radius="0.002"
            ></a-cylinder>
            <a-cylinder
              visible="false"
              color="black"
              position="0 0 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
            <a-cylinder
              data-fret="0"
              visible="false"
              color="black"
              position="0 -0.02276348149776458 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
            <a-cylinder
              data-fret="1"
              visible="false"
              color="black"
              position="0 -0.04162501883506774 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
            <a-cylinder
              data-fret="2"
              visible="false"
              color="black"
              position="0 -0.056381756544113155 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
            <a-cylinder
              data-fret="3"
              visible="false"
              color="black"
              position="0 -0.07231165468692785 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
            <a-cylinder
              data-fret="4"
              visible="false"
              color="black"
              position="0 -0.08465636181831354 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
            <a-cylinder
              data-fret="5"
              visible="false"
              color="black"
              position="0 -0.10065608704090116 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
            <a-cylinder
              data-fret="6"
              visible="false"
              color="black"
              position="0 -0.11525321221351627 0"
              rotation="90 0 0"
              height="0.04"
              radius="0.001"
            ></a-cylinder>
          </a-entity>
        </a-entity>
      </a-entity>
      <a-entity
        id="rightHandControls"
        oculus-touch-controls="hand: right; model: false;"
      ></a-entity>
    </a-scene>
  </body>

  <script>
    const audioContext = Tone.context.rawContext._nativeAudioContext;
    audioContext.addEventListener("statechange", () => {
      console.log("audioContext state:", audioContext.state);
      if (audioContext.state !== "running") {
        document.addEventListener("click", () => audioContext.resume(), {
          once: true,
        });
      }
    });
    audioContext.dispatchEvent(new Event("statechange"));
  </script>

  <script type="module">
    // https://github.com/ianprime0509/pitchy
    // https://ianjohnson.dev/pitchy/
    import { PitchDetector } from "https://esm.sh/pitchy@4";
    window.PitchDetector = PitchDetector;
  </script>
</html>
